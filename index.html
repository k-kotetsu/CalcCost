<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>電卓</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 0; background:#0b0b0f; color:#fff; }
    .wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
    .display { background:#151521; border-radius: 16px; padding: 16px; min-height: 96px; display:flex; flex-direction:column; justify-content:center; }
    .expr { font-size: 16px; opacity:.7; word-break: break-all; min-height: 22px; }
    .result { font-size: 40px; font-weight: 700; text-align: right; word-break: break-all; }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 14px; }
    button { border:0; border-radius: 16px; padding: 16px 0; font-size: 20px; font-weight: 600; background:#23233a; color:#fff; }
    button:active { transform: scale(0.98); opacity: .85; }
    .op { background:#2f2f55; }
    .accent { background:#ff9f0a; color:#101018; }
    .wide { grid-column: span 2; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="display">
      <div class="expr" id="expr"></div>
      <div class="result" id="out">0</div>
    </div>

    <div class="grid">
      <button class="op" data-act="ac">AC</button>
      <button class="op" data-act="del">⌫</button>
      <button class="op" data-val="%">%</button>
      <button class="op" data-val="/">÷</button>

      <button data-val="7">7</button>
      <button data-val="8">8</button>
      <button data-val="9">9</button>
      <button class="op" data-val="*">×</button>

      <button data-val="4">4</button>
      <button data-val="5">5</button>
      <button data-val="6">6</button>
      <button class="op" data-val="-">−</button>

      <button data-val="1">1</button>
      <button data-val="2">2</button>
      <button data-val="3">3</button>
      <button class="op" data-val="+">＋</button>

      <button class="wide" data-val="0">0</button>
      <button data-val=".">.</button>
      <button class="accent" data-act="eq">＝</button>
    </div>
  </div>

  <script>
    const exprEl = document.getElementById('expr');
    const outEl  = document.getElementById('out');

    let expr = "";     // 表示用（演算子含む）
    let input = "0";   // 現在入力中の数値（表示）

    function setOut(v){ outEl.textContent = v; }
    function setExpr(v){ exprEl.textContent = v; }

    function isOp(ch){ return ["+","-","*","/"].includes(ch); }

    function appendVal(v){
      // 演算子
      if (isOp(v)){
        if (expr === "" && input === "0") return;
        if (expr.endsWith(" ") && isOp(expr.trim().slice(-1))){
          expr = expr.trim().slice(0, -1) + v + " ";
        } else {
          expr += (input !== "" ? input : "0") + " " + v + " ";
        }
        input = "";
        setExpr(expr);
        setOut(input || "0");
        return;
      }

      // % は「現在の入力を 0.01 倍」
      if (v === "%"){
        const n = parseFloat(input || "0");
        input = String(n / 100);
        setOut(trimZeros(input));
        return;
      }

      // 数字/小数点
      if (v === "."){
        if (input === "") input = "0";
        if (input.includes(".")) return;
        input += ".";
      } else {
        if (input === "0") input = v;
        else input += v;
      }
      setOut(trimZeros(input));
    }

    function trimZeros(s){
      if (!s.includes(".")) return s;
      return s.replace(/\.?0+$/, m => m.startsWith(".") ? "" : m);
    }

    function backspace(){
      if (input.length > 0){
        input = input.slice(0, -1);
        if (input === "") input = "0";
        setOut(trimZeros(input));
      } else if (expr.length > 0){
        // expr末尾の " op " を削る
        expr = expr.replace(/\s[+\-*/]\s$/, "");
        setExpr(expr);
      }
    }

    function clearAll(){
      expr = "";
      input = "0";
      setExpr("");
      setOut("0");
    }

    function evaluate(){
      const full = (expr + (input === "" ? "0" : input)).trim();
      if (full === "") return;
      try{
        // 安全のため許可文字のみ（数字・演算子・小数点・空白）
        if (!/^[0-9+\-*/.\s]+$/.test(full)) throw new Error("bad");
        // eslint-disable-next-line no-new-func
        const val = Function(`"use strict"; return (${full});`)();
        const shown = formatNumber(val);
        input = shown;
        expr = "";
        setExpr(full + " =");
        setOut(shown);
      } catch(e){
        setExpr(full);
        setOut("Error");
        input = "0";
        expr = "";
      }
    }

    function formatNumber(n){
      if (!isFinite(n)) return "Error";
      // 小数誤差を軽減
      const rounded = Math.round((n + Number.EPSILON) * 1e12) / 1e12;
      return String(rounded);
    }

    document.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act = btn.dataset.act;
        const val = btn.dataset.val;
        if (act === "ac") return clearAll();
        if (act === "del") return backspace();
        if (act === "eq") return evaluate();
        appendVal(val);
      });
    });

    // キーボード対応（外付け）
    window.addEventListener('keydown', (e)=>{
      const k = e.key;
      if ((k >= "0" && k <= "9") || ["+","-","*","/","."].includes(k)) appendVal(k);
      else if (k === "Enter" || k === "=") evaluate();
      else if (k === "Backspace") backspace();
      else if (k === "Escape") clearAll();
    });
  </script>
</body>
</html>
